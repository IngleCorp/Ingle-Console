<div class="tasks-container">
  <!-- Compact Header -->
  <header class="page-header">
    <div class="header-inner">
      <div class="header-left">
        <h1 class="page-title">Tasks</h1>
        <p class="page-subtitle">Organize and track work</p>
      </div>
      <div class="header-actions">
        <button class="btn-ghost" (click)="copyTaskList()" matTooltip="Copy task list">
          <mat-icon>content_copy</mat-icon>
          <span class="btn-label">Copy</span>
        </button>
        <button class="btn-primary" (click)="openTaskDialog(false)">
          <mat-icon>add</mat-icon>
          <span class="btn-label">Add Task</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Compact Search & Filters Bar -->
  <div class="toolbar">
    <div class="search-wrap">
      <mat-icon class="search-icon">search</mat-icon>
      <input
        class="search-input"
        type="text"
        [(ngModel)]="searchTerm"
        (input)="applyFilter()"
        placeholder="Search tasks..."
      />
    </div>
    <div class="filters-wrap">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Status</mat-label>
        <mat-select [(ngModel)]="selectedStatus" (selectionChange)="applyFilter()">
          <mat-option value="all">All</mat-option>
          <mat-option *ngFor="let status of statuses" [value]="status.value">{{ status.label }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Priority</mat-label>
        <mat-select [(ngModel)]="selectedPriority" (selectionChange)="applyFilter()">
          <mat-option value="all">All</mat-option>
          <mat-option *ngFor="let priority of priorities" [value]="priority.value">{{ priority.label }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Assignee</mat-label>
        <mat-select [(ngModel)]="selectedAssignee" (selectionChange)="applyFilter()">
          <mat-option value="all">All</mat-option>
          <mat-option *ngFor="let assignee of assignees" [value]="assignee.name">{{ assignee.name }}</mat-option>
        </mat-select>
      </mat-form-field>
      <div class="view-toggle">
        <button
          type="button"
          class="view-btn"
          [class.view-btn--active]="viewMode === 'kanban'"
          (click)="viewMode = 'kanban'"
          matTooltip="Kanban board"
        >
          <mat-icon>view_module</mat-icon>
          <span class="view-label">Board</span>
        </button>
        <button
          type="button"
          class="view-btn"
          [class.view-btn--active]="viewMode === 'list'"
          (click)="viewMode = 'list'"
          matTooltip="List view"
        >
          <mat-icon>view_list</mat-icon>
          <span class="view-label">List</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Kanban Board -->
  <div class="board-scroll" *ngIf="viewMode === 'kanban'">
    <div class="kanban-board" cdkDropListGroup>

      <!-- ── To Do ── -->
      <section class="column" data-status="todo">
        <div class="column-head">
          <span class="column-dot column-dot--todo"></span>
          <h2 class="column-title">To Do</h2>
          <span class="column-count">{{ todoTasks.length }}</span>
          <button class="col-head-add" (click)="openQuickAdd('todo')" *ngIf="quickAddColumn !== 'todo'" matTooltip="Add task">
            <mat-icon>add</mat-icon>
          </button>
          <button class="col-head-add col-head-add--cancel" (click)="cancelQuickAdd()" *ngIf="quickAddColumn === 'todo'" matTooltip="Cancel">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <!-- Quick-add card — top of column -->
        <div class="quick-add-card" *ngIf="quickAddColumn === 'todo'">
          <input
            class="qa-input"
            [(ngModel)]="quickAddTitle"
            placeholder="Task Name..."
            autofocus
            (keydown.enter)="saveQuickAdd()"
            (keydown.escape)="cancelQuickAdd()">
          <button class="qa-save-btn" (click)="saveQuickAdd()" [disabled]="!quickAddTitle.trim() || quickAddSaving">
            <mat-icon>keyboard_return</mat-icon>
            Save
          </button>
          <div class="qa-meta-row">
            <span class="qa-meta-item"><mat-icon>person_outline</mat-icon> Assignee</span>
            <span class="qa-meta-item"><mat-icon>calendar_today</mat-icon> Date</span>
            <span class="qa-meta-item"><mat-icon>flag_outlined</mat-icon> Priority</span>
            <span class="qa-meta-item"><mat-icon>label_outline</mat-icon> Tag</span>
          </div>
        </div>

        <div class="column-cards" cdkDropList [id]="'todo'" [cdkDropListData]="todoTasks" (cdkDropListDropped)="onTaskDrop($event)">
          <article
            class="card"
            *ngFor="let task of todoTasks"
            cdkDrag
            [cdkDragData]="task"
            [style.border-left-color]="getPriorityColor(task.priority)"
            (click)="openTaskDetails(task.id!)">
            <div class="card-body">
              <h3 class="card-title">{{ getTaskTitle(task) }}</h3>
              <div class="card-tags">
                <span class="tag tag--category" [class]="'tag--' + getTaskCategory(task)">{{ getTaskCategoryLabel(getTaskCategory(task)) }}</span>
                <span class="tag tag--priority" [style.background-color]="getPriorityColor(task.priority)">{{ task.priority || 'medium' }}</span>
              </div>
              <p class="card-desc" *ngIf="getTaskDescription(task)" [innerHTML]="getTaskDescription(task)"></p>
              <div class="card-meta">
                <span class="meta" *ngIf="getTaskAssignees(task).length > 0">
                  <mat-icon>person</mat-icon>{{ getTaskAssignees(task)[0] }}{{ getTaskAssignees(task).length > 1 ? ' +' + (getTaskAssignees(task).length - 1) : '' }}
                </span>
                <span class="meta" *ngIf="getTaskProjectId(task)">
                  <mat-icon>folder</mat-icon>{{ task.projectName || getProjectName(getTaskProjectId(task)) }}
                </span>
                <span class="meta" *ngIf="task.dueDate"><mat-icon>event</mat-icon>{{ task.dueDate | date:'MMM d' }}</span>
                <span class="meta" *ngIf="task.estimatedHours"><mat-icon>schedule</mat-icon>{{ task.estimatedHours }}h</span>
              </div>
              <div class="card-creator">
                <mat-icon>account_circle</mat-icon>{{ getTaskCreatedBy(task) }}
              </div>
            </div>
            <div class="card-footer" (click)="$event.stopPropagation()">
              <div class="card-actions">
                <button class="ca-btn" (click)="openTaskView(task)" matTooltip="Quick view"><mat-icon>visibility</mat-icon></button>
                <button class="ca-btn" (click)="openTaskDetails(task.id!)" matTooltip="Open"><mat-icon>open_in_new</mat-icon></button>
                <button class="ca-btn" (click)="updateTaskStatus(task.id!, 'in-progress')" matTooltip="Start"><mat-icon>play_circle</mat-icon></button>
                <button class="ca-btn" (click)="updateTaskStatus(task.id!, 'hold')" matTooltip="Hold"><mat-icon>pause_circle</mat-icon></button>
                <button class="ca-btn" (click)="openTaskDialog(true, task)" matTooltip="Edit"><mat-icon>edit</mat-icon></button>
                <button class="ca-btn ca-btn--danger" (click)="deleteTask(task.id!)" matTooltip="Delete"><mat-icon>delete</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- ── In Progress ── -->
      <section class="column" data-status="progress">
        <div class="column-head">
          <span class="column-dot column-dot--progress"></span>
          <h2 class="column-title">In Progress</h2>
          <span class="column-count">{{ inProgressTasks.length }}</span>
          <button class="col-head-add" (click)="openQuickAdd('in-progress')" *ngIf="quickAddColumn !== 'in-progress'" matTooltip="Add task">
            <mat-icon>add</mat-icon>
          </button>
          <button class="col-head-add col-head-add--cancel" (click)="cancelQuickAdd()" *ngIf="quickAddColumn === 'in-progress'" matTooltip="Cancel">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <!-- Quick-add card — top of column -->
        <div class="quick-add-card" *ngIf="quickAddColumn === 'in-progress'">
          <input
            class="qa-input"
            [(ngModel)]="quickAddTitle"
            placeholder="Task Name..."
            autofocus
            (keydown.enter)="saveQuickAdd()"
            (keydown.escape)="cancelQuickAdd()">
          <button class="qa-save-btn" (click)="saveQuickAdd()" [disabled]="!quickAddTitle.trim() || quickAddSaving">
            <mat-icon>keyboard_return</mat-icon>
            Save
          </button>
          <div class="qa-meta-row">
            <span class="qa-meta-item"><mat-icon>person_outline</mat-icon> Assignee</span>
            <span class="qa-meta-item"><mat-icon>calendar_today</mat-icon> Date</span>
            <span class="qa-meta-item"><mat-icon>flag_outlined</mat-icon> Priority</span>
            <span class="qa-meta-item"><mat-icon>label_outline</mat-icon> Tag</span>
          </div>
        </div>

        <div class="column-cards" cdkDropList [id]="'in-progress'" [cdkDropListData]="inProgressTasks" (cdkDropListDropped)="onTaskDrop($event)">
          <article class="card" *ngFor="let task of inProgressTasks" cdkDrag [cdkDragData]="task"
            [style.border-left-color]="getPriorityColor(task.priority)"
            (click)="openTaskDetails(task.id!)">
            <div class="card-body">
              <div class="progress-inline">
                <mat-progress-bar [value]="task.progress || 0" color="primary" mode="determinate"></mat-progress-bar>
                <span class="progress-num">{{ task.progress || 0 }}%</span>
              </div>
              <h3 class="card-title">{{ getTaskTitle(task) }}</h3>
              <div class="card-tags">
                <span class="tag tag--category" [class]="'tag--' + getTaskCategory(task)">{{ getTaskCategoryLabel(getTaskCategory(task)) }}</span>
                <span class="tag tag--priority" [style.background-color]="getPriorityColor(task.priority)">{{ task.priority || 'medium' }}</span>
              </div>
              <p class="card-desc" *ngIf="getTaskDescription(task)" [innerHTML]="getTaskDescription(task)"></p>
              <div class="card-meta">
                <span class="meta" *ngIf="getTaskAssignees(task).length > 0">
                  <mat-icon>person</mat-icon>{{ getTaskAssignees(task)[0] }}{{ getTaskAssignees(task).length > 1 ? ' +' + (getTaskAssignees(task).length - 1) : '' }}
                </span>
                <span class="meta" *ngIf="getTaskProjectId(task)">
                  <mat-icon>folder</mat-icon>{{ task.projectName || getProjectName(getTaskProjectId(task)) }}
                </span>
                <span class="meta" *ngIf="task.dueDate"><mat-icon>event</mat-icon>{{ task.dueDate | date:'MMM d' }}</span>
                <span class="meta" *ngIf="task.estimatedHours"><mat-icon>schedule</mat-icon>{{ task.estimatedHours }}h</span>
              </div>
              <div class="card-creator">
                <mat-icon>account_circle</mat-icon>{{ getTaskCreatedBy(task) }}
              </div>
            </div>
            <div class="card-footer" (click)="$event.stopPropagation()">
              <div class="card-actions">
                <button class="ca-btn" (click)="openTaskView(task)" matTooltip="Quick view"><mat-icon>visibility</mat-icon></button>
                <button class="ca-btn" (click)="openTaskDetails(task.id!)" matTooltip="Open"><mat-icon>open_in_new</mat-icon></button>
                <button class="ca-btn ca-btn--success" (click)="updateTaskStatus(task.id!, 'done')" matTooltip="Complete"><mat-icon>check_circle</mat-icon></button>
                <button class="ca-btn" (click)="updateTaskStatus(task.id!, 'hold')" matTooltip="Hold"><mat-icon>pause_circle</mat-icon></button>
                <button class="ca-btn" (click)="openTaskDialog(true, task)" matTooltip="Edit"><mat-icon>edit</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- ── Done ── -->
      <section class="column" data-status="done">
        <div class="column-head">
          <span class="column-dot column-dot--done"></span>
          <h2 class="column-title">Done</h2>
          <span class="column-count">{{ doneTasks.length }}</span>
          <button class="col-head-add" (click)="openQuickAdd('done')" *ngIf="quickAddColumn !== 'done'" matTooltip="Add task">
            <mat-icon>add</mat-icon>
          </button>
          <button class="col-head-add col-head-add--cancel" (click)="cancelQuickAdd()" *ngIf="quickAddColumn === 'done'" matTooltip="Cancel">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <!-- Quick-add card — top of column -->
        <div class="quick-add-card" *ngIf="quickAddColumn === 'done'">
          <input
            class="qa-input"
            [(ngModel)]="quickAddTitle"
            placeholder="Task Name..."
            autofocus
            (keydown.enter)="saveQuickAdd()"
            (keydown.escape)="cancelQuickAdd()">
          <button class="qa-save-btn" (click)="saveQuickAdd()" [disabled]="!quickAddTitle.trim() || quickAddSaving">
            <mat-icon>keyboard_return</mat-icon>
            Save
          </button>
          <div class="qa-meta-row">
            <span class="qa-meta-item"><mat-icon>person_outline</mat-icon> Assignee</span>
            <span class="qa-meta-item"><mat-icon>calendar_today</mat-icon> Date</span>
            <span class="qa-meta-item"><mat-icon>flag_outlined</mat-icon> Priority</span>
            <span class="qa-meta-item"><mat-icon>label_outline</mat-icon> Tag</span>
          </div>
        </div>

        <div class="column-cards" cdkDropList [id]="'done'" [cdkDropListData]="doneTasks" (cdkDropListDropped)="onTaskDrop($event)">
          <article class="card" *ngFor="let task of doneTasks" cdkDrag [cdkDragData]="task"
            [style.border-left-color]="getPriorityColor(task.priority)"
            (click)="openTaskDetails(task.id!)">
            <div class="card-body">
              <h3 class="card-title">{{ getTaskTitle(task) }}</h3>
              <div class="card-tags">
                <span class="tag tag--category" [class]="'tag--' + getTaskCategory(task)">{{ getTaskCategoryLabel(getTaskCategory(task)) }}</span>
                <span class="tag tag--priority" [style.background-color]="getPriorityColor(task.priority)">{{ task.priority || 'medium' }}</span>
              </div>
              <p class="card-desc" *ngIf="getTaskDescription(task)" [innerHTML]="getTaskDescription(task)"></p>
              <div class="card-meta">
                <span class="meta" *ngIf="task.updatedAt"><mat-icon>check_circle</mat-icon>{{ task.updatedAt | date:'MMM d' }}</span>
                <span class="meta" *ngIf="task.timeTaken"><mat-icon>timer</mat-icon>{{ task.timeTaken }}h</span>
              </div>
              <div class="card-creator">
                <mat-icon>account_circle</mat-icon>{{ getTaskCreatedBy(task) }}
              </div>
            </div>
            <div class="card-footer" (click)="$event.stopPropagation()">
              <div class="card-actions">
                <button class="ca-btn" (click)="openTaskView(task)" matTooltip="Quick view"><mat-icon>visibility</mat-icon></button>
                <button class="ca-btn" (click)="openTaskDetails(task.id!)" matTooltip="Open"><mat-icon>open_in_new</mat-icon></button>
                <button class="ca-btn" (click)="updateTaskStatus(task.id!, 'todo')" matTooltip="Reopen"><mat-icon>undo</mat-icon></button>
                <button class="ca-btn" (click)="openTaskDialog(true, task)" matTooltip="Edit"><mat-icon>edit</mat-icon></button>
                <button class="ca-btn ca-btn--danger" (click)="deleteTask(task.id!)" matTooltip="Delete"><mat-icon>delete</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- ── On Hold ── -->
      <section class="column" data-status="hold">
        <div class="column-head">
          <span class="column-dot column-dot--hold"></span>
          <h2 class="column-title">On Hold</h2>
          <span class="column-count">{{ holdTasks.length }}</span>
          <button class="col-head-add" (click)="openQuickAdd('hold')" *ngIf="quickAddColumn !== 'hold'" matTooltip="Add task">
            <mat-icon>add</mat-icon>
          </button>
          <button class="col-head-add col-head-add--cancel" (click)="cancelQuickAdd()" *ngIf="quickAddColumn === 'hold'" matTooltip="Cancel">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <!-- Quick-add card — top of column -->
        <div class="quick-add-card" *ngIf="quickAddColumn === 'hold'">
          <input
            class="qa-input"
            [(ngModel)]="quickAddTitle"
            placeholder="Task Name..."
            autofocus
            (keydown.enter)="saveQuickAdd()"
            (keydown.escape)="cancelQuickAdd()">
          <button class="qa-save-btn" (click)="saveQuickAdd()" [disabled]="!quickAddTitle.trim() || quickAddSaving">
            <mat-icon>keyboard_return</mat-icon>
            Save
          </button>
          <div class="qa-meta-row">
            <span class="qa-meta-item"><mat-icon>person_outline</mat-icon> Assignee</span>
            <span class="qa-meta-item"><mat-icon>calendar_today</mat-icon> Date</span>
            <span class="qa-meta-item"><mat-icon>flag_outlined</mat-icon> Priority</span>
            <span class="qa-meta-item"><mat-icon>label_outline</mat-icon> Tag</span>
          </div>
        </div>

        <div class="column-cards" cdkDropList [id]="'hold'" [cdkDropListData]="holdTasks" (cdkDropListDropped)="onTaskDrop($event)">
          <article class="card" *ngFor="let task of holdTasks" cdkDrag [cdkDragData]="task"
            [style.border-left-color]="getPriorityColor(task.priority)"
            (click)="openTaskDetails(task.id!)">
            <div class="card-body">
              <h3 class="card-title">{{ getTaskTitle(task) }}</h3>
              <div class="card-tags">
                <span class="tag tag--category" [class]="'tag--' + getTaskCategory(task)">{{ getTaskCategoryLabel(getTaskCategory(task)) }}</span>
                <span class="tag tag--priority" [style.background-color]="getPriorityColor(task.priority)">{{ task.priority || 'medium' }}</span>
              </div>
              <p class="card-desc" *ngIf="getTaskDescription(task)" [innerHTML]="getTaskDescription(task)"></p>
              <div class="card-meta">
                <span class="meta" *ngIf="getTaskProjectId(task)">
                  <mat-icon>folder</mat-icon>{{ task.projectName || getProjectName(getTaskProjectId(task)) }}
                </span>
                <span class="meta" *ngIf="task.updatedAt"><mat-icon>schedule</mat-icon>{{ task.updatedAt | date:'MMM d' }}</span>
              </div>
              <div class="card-creator">
                <mat-icon>account_circle</mat-icon>{{ getTaskCreatedBy(task) }}
              </div>
            </div>
            <div class="card-footer" (click)="$event.stopPropagation()">
              <div class="card-actions">
                <button class="ca-btn" (click)="openTaskView(task)" matTooltip="Quick view"><mat-icon>visibility</mat-icon></button>
                <button class="ca-btn" (click)="openTaskDetails(task.id!)" matTooltip="Open"><mat-icon>open_in_new</mat-icon></button>
                <button class="ca-btn" (click)="updateTaskStatus(task.id!, 'todo')" matTooltip="Back to Todo"><mat-icon>undo</mat-icon></button>
                <button class="ca-btn" (click)="updateTaskStatus(task.id!, 'in-progress')" matTooltip="Resume"><mat-icon>play_circle</mat-icon></button>
                <button class="ca-btn" (click)="openTaskDialog(true, task)" matTooltip="Edit"><mat-icon>edit</mat-icon></button>
                <button class="ca-btn ca-btn--danger" (click)="deleteTask(task.id!)" matTooltip="Delete"><mat-icon>delete</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </section>

    </div>
  </div>

  <!-- List View (header always visible when in list mode; body shows rows or empty state) -->
  <div class="list-view" *ngIf="viewMode === 'list' && !isLoading">
    <div class="list-table">
      <div class="list-head">
        <div class="list-th list-th--title">
            <div class="list-th-top">
              <span class="list-th-label">Task</span>
              <button
                type="button"
                class="list-th-sort"
                (click)="setListSort('title')"
                matTooltip="Sort"
                [class.list-th-sort--active]="listSortColumn === 'title'">
                <mat-icon>{{ getListSortIcon('title') }}</mat-icon>
              </button>
            </div>
        </div>
        <div class="list-th list-th--category">
            <div class="list-th-top">
              <span class="list-th-label">Category</span>
              <button
                type="button"
                class="list-th-sort"
                (click)="setListSort('category')"
                matTooltip="Sort"
                [class.list-th-sort--active]="listSortColumn === 'category'">
                <mat-icon>{{ getListSortIcon('category') }}</mat-icon>
              </button>
            </div>
          <mat-form-field appearance="outline" class="list-th-filter" [class.list-th-filter--active]="isListFilterActive('category')">
            <mat-select [(ngModel)]="listFilterCategory" placeholder="All">
              <mat-option value="all">All</mat-option>
              <mat-option value="general">General</mat-option>
              <mat-option value="clientProject">Client Project</mat-option>
              <mat-option value="ownProject">Own Project</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="list-th list-th--priority">
            <div class="list-th-top">
              <span class="list-th-label">Priority</span>
              <button
                type="button"
                class="list-th-sort"
                (click)="setListSort('priority')"
                matTooltip="Sort"
                [class.list-th-sort--active]="listSortColumn === 'priority'">
                <mat-icon>{{ getListSortIcon('priority') }}</mat-icon>
              </button>
            </div>
          <mat-form-field appearance="outline" class="list-th-filter" [class.list-th-filter--active]="isListFilterActive('priority')">
            <mat-select [(ngModel)]="listFilterPriority" placeholder="All">
              <mat-option value="all">All</mat-option>
              <mat-option *ngFor="let p of priorities" [value]="p.value">{{ p.label }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="list-th list-th--status">
            <div class="list-th-top">
              <span class="list-th-label">Status</span>
              <button
                type="button"
                class="list-th-sort"
                (click)="setListSort('status')"
                matTooltip="Sort"
                [class.list-th-sort--active]="listSortColumn === 'status'">
                <mat-icon>{{ getListSortIcon('status') }}</mat-icon>
              </button>
            </div>
          <mat-form-field appearance="outline" class="list-th-filter" [class.list-th-filter--active]="isListFilterActive('status')">
            <mat-select [(ngModel)]="listFilterStatus" placeholder="All">
              <mat-option value="all">All</mat-option>
              <mat-option *ngFor="let s of statuses" [value]="s.value">{{ s.label }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="list-th list-th--assignee">
            <div class="list-th-top">
              <span class="list-th-label">Assignee</span>
              <button
                type="button"
                class="list-th-sort"
                (click)="setListSort('assignee')"
                matTooltip="Sort"
                [class.list-th-sort--active]="listSortColumn === 'assignee'">
                <mat-icon>{{ getListSortIcon('assignee') }}</mat-icon>
              </button>
            </div>
          <mat-form-field appearance="outline" class="list-th-filter" [class.list-th-filter--active]="isListFilterActive('assignee')">
              <mat-select [(ngModel)]="listFilterAssignee" placeholder="All">
                <mat-option value="all">All</mat-option>
                <mat-option *ngFor="let a of assignees" [value]="a.name">{{ a.name }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="list-th list-th--project">
            <div class="list-th-top">
              <span class="list-th-label">Project</span>
              <button
                type="button"
                class="list-th-sort"
                (click)="setListSort('project')"
                matTooltip="Sort"
                [class.list-th-sort--active]="listSortColumn === 'project'">
                <mat-icon>{{ getListSortIcon('project') }}</mat-icon>
              </button>
            </div>
            <mat-form-field
              appearance="outline"
              class="list-th-filter"
              [class.list-th-filter--active]="isListFilterActive('project')">
              <mat-select [(ngModel)]="listFilterProject" placeholder="All">
                <mat-option value="all">All</mat-option>
                <mat-option value="none">No project</mat-option>
                <mat-option *ngFor="let label of projectFilterLabels" [value]="label">{{ label }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        <div class="list-th list-th--date">
            <div class="list-th-top">
              <span class="list-th-label">Due</span>
              <button
                type="button"
                class="list-th-sort"
                (click)="setListSort('dueDate')"
                matTooltip="Sort"
                [class.list-th-sort--active]="listSortColumn === 'dueDate'">
                <mat-icon>{{ getListSortIcon('dueDate') }}</mat-icon>
              </button>
            </div>
            <mat-form-field
              appearance="outline"
              class="list-th-filter"
              [class.list-th-filter--active]="isListFilterActive('due')">
              <mat-select [(ngModel)]="listFilterDue" placeholder="All">
                <mat-option value="all">All</mat-option>
                <mat-option value="overdue">Overdue</mat-option>
                <mat-option value="thisWeek">This week</mat-option>
                <mat-option value="noDate">No date</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        <div class="list-th list-th--actions"></div>
      </div>
      <div class="list-body">
        <ng-container *ngIf="listViewData.length > 0">
          <div
            class="list-row"
            *ngFor="let task of listViewData"
            [class.list-row--urgent]="task.priority === 'high' || task.priority === 'urgent'"
          >
            <div class="list-cell list-cell--title">
              <span class="list-priority" [style.background-color]="getPriorityColor(task.priority)"></span>
              <span class="list-title" (click)="openTaskView(task)">{{ getTaskTitle(task) }}</span>
            </div>
            <div class="list-cell list-cell--category">
              <span class="tag tag--category" [class]="'tag--' + getTaskCategory(task)">{{ getTaskCategoryLabel(getTaskCategory(task)) }}</span>
            </div>
            <div class="list-cell list-cell--priority">
              <span class="tag tag--priority" [style.background-color]="getPriorityColor(task.priority)">{{ task.priority || 'medium' }}</span>
            </div>
            <div class="list-cell list-cell--status">
              <span class="status-pill" [class]="'status-pill--' + task.status">{{ getStatusLabel(task.status) }}</span>
            </div>
            <div class="list-cell list-cell--assignee">
              <span class="meta" *ngIf="getTaskAssignees(task).length > 0">
                {{ getTaskAssignees(task)[0] }}{{ getTaskAssignees(task).length > 1 ? ' +' + (getTaskAssignees(task).length - 1) : '' }}
              </span>
              <span class="meta meta--muted" *ngIf="getTaskAssignees(task).length === 0">—</span>
            </div>
            <div class="list-cell list-cell--project">
              <span class="meta" *ngIf="getTaskProjectId(task)">
                {{ task.projectName || getProjectName(getTaskProjectId(task)) }}
              </span>
              <span class="meta meta--muted" *ngIf="!getTaskProjectId(task)">—</span>
            </div>
            <div class="list-cell list-cell--date">
              <span *ngIf="task.dueDate">{{ task.dueDate | date:'shortDate' }}</span>
              <span class="meta--muted" *ngIf="!task.dueDate">—</span>
            </div>
            <div class="list-cell list-cell--actions">
              <div class="list-actions">
              <button class="ca-btn" (click)="openTaskView(task)" matTooltip="Quick view"><mat-icon>visibility</mat-icon></button>
              <button class="ca-btn" (click)="openTaskDetails(task.id!)" matTooltip="Open in page"><mat-icon>open_in_new</mat-icon></button>
              <button class="ca-btn" (click)="openTaskDialog(true, task)" matTooltip="Edit"><mat-icon>edit</mat-icon></button>
              <button class="ca-btn ca-btn--danger" (click)="deleteTask(task.id!)" matTooltip="Delete"><mat-icon>delete</mat-icon></button>
              </div>
            </div>
          </div>
        </ng-container>
        <div class="list-empty" *ngIf="listViewData.length === 0">
          <mat-icon>filter_list</mat-icon>
          <p class="list-empty-title">{{ tasks.length === 0 ? 'No tasks yet' : 'No tasks match your filters' }}</p>
          <p class="list-empty-hint">{{ tasks.length === 0 ? 'Add your first task to get started.' : 'Try changing search or column filters to see more tasks.' }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="state state--loading" *ngIf="isLoading">
    <mat-spinner diameter="32"></mat-spinner>
    <span>Loading tasks...</span>
  </div>

  <!-- Empty (no tasks at all) — only when not in list view; list view shows its own empty state -->
  <div class="state state--empty" *ngIf="!isLoading && tasks.length === 0 && viewMode !== 'list'">
    <mat-icon>assignment_outlined</mat-icon>
    <h3>No tasks yet</h3>
    <p>Add your first task to get started.</p>
    <button mat-raised-button color="primary" (click)="openTaskDialog(false)">
      <mat-icon>add</mat-icon>
      Add Task
    </button>
  </div>
</div>
