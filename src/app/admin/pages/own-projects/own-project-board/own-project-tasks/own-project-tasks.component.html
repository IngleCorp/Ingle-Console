<div class="tasks-page">
  <header class="tasks-header">
    <div class="header-top">
      <div class="header-title">
        <h1 class="title">Tasks</h1>
        <span class="subtitle">Manage tasks</span>
      </div>
      <div class="header-actions">
        <div class="view-switcher" role="group" aria-label="View mode">
          <button type="button" class="switch-btn" [class.active]="viewMode === 'kanban'" (click)="viewMode = 'kanban'" title="Board view">
            <mat-icon>view_kanban</mat-icon>
            <span>Board</span>
          </button>
          <button type="button" class="switch-btn" [class.active]="viewMode === 'list'" (click)="viewMode = 'list'" title="List view">
            <mat-icon>view_list</mat-icon>
            <span>List</span>
          </button>
        </div>
      </div>
    </div>
    <div class="header-stats">
      <div class="stat todo"><span class="stat-num">{{ tasktodo?.length || 0 }}</span><span class="stat-lbl">To Do</span></div>
      <div class="stat inprogress"><span class="stat-num">{{ taskinprogress?.length || 0 }}</span><span class="stat-lbl">In Progress</span></div>
      <div class="stat done"><span class="stat-num">{{ taskdone?.length || 0 }}</span><span class="stat-lbl">Done</span></div>
      <div class="stat hold"><span class="stat-num">{{ taskonhold?.length || 0 }}</span><span class="stat-lbl">On Hold</span></div>
    </div>
  </header>

  <div class="add-bar">
    <mat-form-field appearance="outline" class="add-field">
      <mat-label>New task</mat-label>
      <input matInput [(ngModel)]="taskText" (keyup.enter)="addTask()" placeholder="Add a task...">
    </mat-form-field>
    <button mat-flat-button color="primary" class="add-btn" (click)="addTask()" [disabled]="!taskText?.trim() || isLoading">
      <mat-icon>add</mat-icon>
      Add
    </button>
  </div>

  <div class="loading-state" *ngIf="isLoading && !taskdata?.length">
    <mat-spinner diameter="32"></mat-spinner>
  </div>

  <!-- Kanban view (drag & drop between columns to change status) -->
  <div class="kanban-view" *ngIf="viewMode === 'kanban' && (!isLoading || taskdata?.length)">
    <div class="kanban-board" cdkDropListGroup>
      <div class="col todo-col">
        <div class="col-head">
          <mat-icon>pending</mat-icon>
          <span>To Do</span>
          <span class="count">{{ tasktodo?.length || 0 }}</span>
        </div>
        <div class="col-cards" cdkDropList [id]="'todo'" [cdkDropListData]="tasktodo" (cdkDropListDropped)="onTaskDrop($event)">
          <article class="task-card" *ngFor="let task of tasktodo; trackBy: trackByTask" cdkDrag [cdkDragData]="task" (click)="goToTaskDetail(task.id)">
            <div class="task-card-accent todo"></div>
            <div class="task-card-body">
              <h3 class="task-card-title">{{ task.title }}</h3>
              <p class="task-card-desc" *ngIf="task.description">{{ task.description }}</p>
              <div class="task-card-meta">
                <span class="task-card-assignees" *ngIf="getAssigneesDisplay(task)"><mat-icon>person_outline</mat-icon>{{ getAssigneesDisplay(task) }}</span>
                <span class="task-card-priority pill" *ngIf="task.priority" [class]="task.priority">{{ getPriorityLabel(task.priority) }}</span>
              </div>
              <div class="task-card-actions" (click)="$event.stopPropagation()">
                <button mat-icon-button (click)="deleteTask(task.id)" matTooltip="Delete" class="action-delete"><mat-icon>delete_outline</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </div>
      <div class="col inprogress-col">
        <div class="col-head">
          <mat-icon>progress_activity</mat-icon>
          <span>In Progress</span>
          <span class="count">{{ taskinprogress?.length || 0 }}</span>
        </div>
        <div class="col-cards" cdkDropList [id]="'in-progress'" [cdkDropListData]="taskinprogress" (cdkDropListDropped)="onTaskDrop($event)">
          <article class="task-card" *ngFor="let task of taskinprogress; trackBy: trackByTask" cdkDrag [cdkDragData]="task" (click)="goToTaskDetail(task.id)">
            <div class="task-card-accent inprogress"></div>
            <div class="task-card-body">
              <h3 class="task-card-title">{{ task.title }}</h3>
              <p class="task-card-desc" *ngIf="task.description">{{ task.description }}</p>
              <div class="task-card-progress" *ngIf="task.progress != null">
                <div class="progress-bar"><div class="progress-fill" [style.width.%]="task.progress"></div></div>
                <span class="progress-label">{{ task.progress }}%</span>
              </div>
              <div class="task-card-meta">
                <span class="task-card-assignees" *ngIf="getAssigneesDisplay(task)"><mat-icon>person_outline</mat-icon>{{ getAssigneesDisplay(task) }}</span>
                <span class="task-card-priority pill" *ngIf="task.priority" [class]="task.priority">{{ getPriorityLabel(task.priority) }}</span>
              </div>
              <div class="task-card-actions" (click)="$event.stopPropagation()">
                <button mat-icon-button (click)="deleteTask(task.id)" matTooltip="Delete" class="action-delete"><mat-icon>delete_outline</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </div>
      <div class="col done-col">
        <div class="col-head">
          <mat-icon>check_circle</mat-icon>
          <span>Done</span>
          <span class="count">{{ taskdone?.length || 0 }}</span>
        </div>
        <div class="col-cards" cdkDropList [id]="'done'" [cdkDropListData]="taskdone" (cdkDropListDropped)="onTaskDrop($event)">
          <article class="task-card done" *ngFor="let task of taskdone; trackBy: trackByTask" cdkDrag [cdkDragData]="task" (click)="goToTaskDetail(task.id)">
            <div class="task-card-accent done"></div>
            <div class="task-card-body">
              <h3 class="task-card-title">{{ task.title }}</h3>
              <p class="task-card-desc" *ngIf="task.description">{{ task.description }}</p>
              <div class="task-card-meta">
                <span class="task-card-assignees" *ngIf="getAssigneesDisplay(task)"><mat-icon>person_outline</mat-icon>{{ getAssigneesDisplay(task) }}</span>
              </div>
              <div class="task-card-actions" (click)="$event.stopPropagation()">
                <button mat-icon-button (click)="deleteTask(task.id)" matTooltip="Delete" class="action-delete"><mat-icon>delete_outline</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </div>
      <div class="col hold-col">
        <div class="col-head">
          <mat-icon>pause_circle</mat-icon>
          <span>On Hold</span>
          <span class="count">{{ taskonhold?.length || 0 }}</span>
        </div>
        <div class="col-cards" cdkDropList [id]="'hold'" [cdkDropListData]="taskonhold" (cdkDropListDropped)="onTaskDrop($event)">
          <article class="task-card hold" *ngFor="let task of taskonhold; trackBy: trackByTask" cdkDrag [cdkDragData]="task" (click)="goToTaskDetail(task.id)">
            <div class="task-card-accent hold"></div>
            <div class="task-card-body">
              <h3 class="task-card-title">{{ task.title }}</h3>
              <p class="task-card-desc" *ngIf="task.description">{{ task.description }}</p>
              <div class="task-card-meta">
                <span class="task-card-assignees" *ngIf="getAssigneesDisplay(task)"><mat-icon>person_outline</mat-icon>{{ getAssigneesDisplay(task) }}</span>
                <span class="task-card-priority pill" *ngIf="task.priority" [class]="task.priority">{{ getPriorityLabel(task.priority) }}</span>
              </div>
              <div class="task-card-actions" (click)="$event.stopPropagation()">
                <button mat-icon-button (click)="deleteTask(task.id)" matTooltip="Delete" class="action-delete"><mat-icon>delete_outline</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </div>
    </div>
  </div>

  <!-- List view -->
  <div class="list-view" *ngIf="viewMode === 'list' && (!isLoading || taskdata?.length)">
    <div class="list-toolbar">
      <span class="list-total">{{ taskdata?.length || 0 }} task{{ (taskdata?.length || 0) === 1 ? '' : 's' }}</span>
    </div>
    <div class="list-body">
      <div class="list-row" *ngFor="let task of taskdata; trackBy: trackByTask" (click)="goToTaskDetail(task.id)">
        <span class="row-status pill" [class]="(task.status || 'todo')">{{ getStatusLabel(task.status || 'todo') }}</span>
        <span class="row-title">{{ task.title }}</span>
        <span class="row-meta" *ngIf="getAssigneesDisplay(task)">{{ getAssigneesDisplay(task) }}</span>
        <span class="row-priority pill" *ngIf="task.priority" [class]="task.priority">{{ getPriorityLabel(task.priority) }}</span>
        <div class="row-actions" (click)="$event.stopPropagation()">
          <button mat-icon-button [matMenuTriggerFor]="rowMenu" matTooltip="Actions"><mat-icon>more_horiz</mat-icon></button>
          <mat-menu #rowMenu="matMenu" xPosition="before">
            <button mat-menu-item (click)="updateTaskStatus(task.id, 'todo')"><mat-icon>pending</mat-icon><span>To Do</span></button>
            <button mat-menu-item (click)="updateTaskStatus(task.id, 'in-progress')"><mat-icon>progress_activity</mat-icon><span>In Progress</span></button>
            <button mat-menu-item (click)="updateTaskStatus(task.id, 'done')"><mat-icon>check_circle</mat-icon><span>Done</span></button>
            <button mat-menu-item (click)="updateTaskStatus(task.id, 'hold')"><mat-icon>pause_circle</mat-icon><span>On Hold</span></button>
            <button mat-menu-item (click)="deleteTask(task.id)"><mat-icon>delete</mat-icon><span>Delete</span></button>
          </mat-menu>
        </div>
      </div>
    </div>
  </div>

  <div class="empty-state" *ngIf="!isLoading && !taskdata?.length">
    <mat-icon class="empty-icon">assignment</mat-icon>
    <p class="empty-title">No tasks yet</p>
    <p class="empty-desc">Add a task above or open one to set assignees and details.</p>
  </div>
</div>
