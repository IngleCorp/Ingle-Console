<div class="opt-page">

  <!-- ── Header ── -->
  <div class="opt-toolbar">
    <div class="opt-toolbar-left">
      <span class="opt-title">Tasks</span>
      <span class="opt-count-pill opt-count-pill--todo">{{ tasktodo.length }} To Do</span>
      <span class="opt-count-pill opt-count-pill--progress">{{ taskinprogress.length }} In Progress</span>
      <span class="opt-count-pill opt-count-pill--done">{{ taskdone.length }} Done</span>
      <span class="opt-count-pill opt-count-pill--hold">{{ taskonhold.length }} On Hold</span>
    </div>
    <div class="opt-toolbar-right">
      <div class="opt-view-switcher">
        <button type="button" class="opt-view-btn" [class.opt-view-btn--active]="viewMode === 'kanban'" (click)="viewMode = 'kanban'" matTooltip="Board view">
          <mat-icon>view_module</mat-icon>
          <span>Board</span>
        </button>
        <button type="button" class="opt-view-btn" [class.opt-view-btn--active]="viewMode === 'list'" (click)="viewMode = 'list'" matTooltip="List view">
          <mat-icon>view_list</mat-icon>
          <span>List</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ── Loading ── -->
  <div class="opt-loading" *ngIf="isLoading && !taskdata.length">
    <mat-spinner diameter="28"></mat-spinner>
  </div>

  <!-- ══════════════════ KANBAN VIEW ══════════════════ -->
  <div class="opt-board-scroll" *ngIf="viewMode === 'kanban' && (!isLoading || taskdata.length)">
    <div class="opt-kanban-board" cdkDropListGroup>

      <!-- ── To Do ── -->
      <section class="opt-column">
        <div class="opt-col-head">
          <span class="opt-col-dot opt-col-dot--todo"></span>
          <h2 class="opt-col-title">To Do</h2>
          <span class="opt-col-count">{{ tasktodo.length }}</span>
          <button class="opt-col-add" (click)="openQuickAdd('todo')" *ngIf="quickAddColumn !== 'todo'" matTooltip="Add task">
            <mat-icon>add</mat-icon>
          </button>
          <button class="opt-col-add opt-col-add--cancel" (click)="cancelQuickAdd()" *ngIf="quickAddColumn === 'todo'" matTooltip="Cancel">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Quick-add -->
        <div class="opt-quick-add" *ngIf="quickAddColumn === 'todo'">
          <input class="opt-qa-input" [(ngModel)]="quickAddTitle" placeholder="Task name…" autofocus
            (keydown.enter)="saveQuickAdd()" (keydown.escape)="cancelQuickAdd()">
          <button class="opt-qa-save" (click)="saveQuickAdd()" [disabled]="!quickAddTitle.trim() || quickAddSaving">
            <mat-icon>keyboard_return</mat-icon> Save
          </button>
          <div class="opt-qa-hints">
            <span><mat-icon>person_outline</mat-icon> Assignee</span>
            <span><mat-icon>calendar_today</mat-icon> Date</span>
            <span><mat-icon>flag_outlined</mat-icon> Priority</span>
          </div>
        </div>

        <div class="opt-col-cards" cdkDropList [id]="'todo'" [cdkDropListData]="tasktodo" (cdkDropListDropped)="onTaskDrop($event)">
          <article class="opt-card" *ngFor="let task of tasktodo; trackBy: trackByTask"
            cdkDrag [cdkDragData]="task"
            [style.border-left-color]="getPriorityColor(task.priority)"
            (click)="goToTaskDetail(task.id)">
            <div class="opt-card-body">
              <h3 class="opt-card-title">{{ getTaskTitle(task) }}</h3>
              <p class="opt-card-desc" *ngIf="task.description">{{ task.description }}</p>
              <div class="opt-card-assignees">
                <ng-container *ngIf="getAssigneesList(task).length; else noAssignees">
                  <span class="opt-assignee-chip" *ngFor="let a of getAssigneesList(task)" [matTooltip]="a.name">
                    <span class="opt-assignee-initial">{{ (a.name || '?')[0] | uppercase }}</span>
                    <span class="opt-assignee-name">{{ a.name }}</span>
                  </span>
                </ng-container>
                <ng-template #noAssignees>
                  <span class="opt-assignees-empty"><mat-icon>person_outline</mat-icon> Unassigned</span>
                </ng-template>
              </div>
              <div class="opt-card-meta">
                <span class="opt-meta" *ngIf="task.dueDate">
                  <mat-icon>event</mat-icon>{{ task.dueDate | date:'MMM d' }}
                </span>
                <span class="opt-meta" *ngIf="task.priority">
                  <mat-icon>flag</mat-icon>{{ getPriorityLabel(task.priority) }}
                </span>
              </div>
              <div class="opt-card-creator">
                <mat-icon>account_circle</mat-icon>{{ getTaskCreatedBy(task) }}
              </div>
            </div>
            <div class="opt-card-footer" (click)="$event.stopPropagation()">
              <div class="opt-card-actions">
                <button class="opt-ca-btn" (click)="goToTaskDetail(task.id)" matTooltip="Open"><mat-icon>open_in_new</mat-icon></button>
                <button class="opt-ca-btn" (click)="updateTaskStatus(task.id, 'in-progress')" matTooltip="Start"><mat-icon>play_circle</mat-icon></button>
                <button class="opt-ca-btn" (click)="updateTaskStatus(task.id, 'hold')" matTooltip="Hold"><mat-icon>pause_circle</mat-icon></button>
                <button class="opt-ca-btn opt-ca-btn--danger" (click)="deleteTask(task.id)" matTooltip="Delete"><mat-icon>delete</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- ── In Progress ── -->
      <section class="opt-column">
        <div class="opt-col-head">
          <span class="opt-col-dot opt-col-dot--progress"></span>
          <h2 class="opt-col-title">In Progress</h2>
          <span class="opt-col-count">{{ taskinprogress.length }}</span>
          <button class="opt-col-add" (click)="openQuickAdd('in-progress')" *ngIf="quickAddColumn !== 'in-progress'" matTooltip="Add task">
            <mat-icon>add</mat-icon>
          </button>
          <button class="opt-col-add opt-col-add--cancel" (click)="cancelQuickAdd()" *ngIf="quickAddColumn === 'in-progress'" matTooltip="Cancel">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Quick-add -->
        <div class="opt-quick-add" *ngIf="quickAddColumn === 'in-progress'">
          <input class="opt-qa-input" [(ngModel)]="quickAddTitle" placeholder="Task name…" autofocus
            (keydown.enter)="saveQuickAdd()" (keydown.escape)="cancelQuickAdd()">
          <button class="opt-qa-save" (click)="saveQuickAdd()" [disabled]="!quickAddTitle.trim() || quickAddSaving">
            <mat-icon>keyboard_return</mat-icon> Save
          </button>
          <div class="opt-qa-hints">
            <span><mat-icon>person_outline</mat-icon> Assignee</span>
            <span><mat-icon>calendar_today</mat-icon> Date</span>
            <span><mat-icon>flag_outlined</mat-icon> Priority</span>
          </div>
        </div>

        <div class="opt-col-cards" cdkDropList [id]="'in-progress'" [cdkDropListData]="taskinprogress" (cdkDropListDropped)="onTaskDrop($event)">
          <article class="opt-card" *ngFor="let task of taskinprogress; trackBy: trackByTask"
            cdkDrag [cdkDragData]="task"
            [style.border-left-color]="getPriorityColor(task.priority)"
            (click)="goToTaskDetail(task.id)">
            <div class="opt-card-body">
              <!-- Progress bar -->
              <div class="opt-card-progress" *ngIf="task.progress != null">
                <div class="opt-prog-track">
                  <div class="opt-prog-fill" [style.width.%]="task.progress"></div>
                </div>
                <span class="opt-prog-pct">{{ task.progress }}%</span>
              </div>
              <h3 class="opt-card-title">{{ getTaskTitle(task) }}</h3>
              <p class="opt-card-desc" *ngIf="task.description">{{ task.description }}</p>
              <div class="opt-card-assignees">
                <ng-container *ngIf="getAssigneesList(task).length; else noAssigneesInProgress">
                  <span class="opt-assignee-chip" *ngFor="let a of getAssigneesList(task)" [matTooltip]="a.name">
                    <span class="opt-assignee-initial">{{ (a.name || '?')[0] | uppercase }}</span>
                    <span class="opt-assignee-name">{{ a.name }}</span>
                  </span>
                </ng-container>
                <ng-template #noAssigneesInProgress>
                  <span class="opt-assignees-empty"><mat-icon>person_outline</mat-icon> Unassigned</span>
                </ng-template>
              </div>
              <div class="opt-card-meta">
                <span class="opt-meta" *ngIf="task.dueDate">
                  <mat-icon>event</mat-icon>{{ task.dueDate | date:'MMM d' }}
                </span>
                <span class="opt-meta" *ngIf="task.priority">
                  <mat-icon>flag</mat-icon>{{ getPriorityLabel(task.priority) }}
                </span>
              </div>
              <div class="opt-card-creator">
                <mat-icon>account_circle</mat-icon>{{ getTaskCreatedBy(task) }}
              </div>
            </div>
            <div class="opt-card-footer" (click)="$event.stopPropagation()">
              <div class="opt-card-actions">
                <button class="opt-ca-btn" (click)="goToTaskDetail(task.id)" matTooltip="Open"><mat-icon>open_in_new</mat-icon></button>
                <button class="opt-ca-btn opt-ca-btn--success" (click)="updateTaskStatus(task.id, 'done')" matTooltip="Complete"><mat-icon>check_circle</mat-icon></button>
                <button class="opt-ca-btn" (click)="updateTaskStatus(task.id, 'hold')" matTooltip="Hold"><mat-icon>pause_circle</mat-icon></button>
                <button class="opt-ca-btn opt-ca-btn--danger" (click)="deleteTask(task.id)" matTooltip="Delete"><mat-icon>delete</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- ── Done ── -->
      <section class="opt-column">
        <div class="opt-col-head">
          <span class="opt-col-dot opt-col-dot--done"></span>
          <h2 class="opt-col-title">Done</h2>
          <span class="opt-col-count">{{ taskdone.length }}</span>
          <button class="opt-col-add" (click)="openQuickAdd('done')" *ngIf="quickAddColumn !== 'done'" matTooltip="Add task">
            <mat-icon>add</mat-icon>
          </button>
          <button class="opt-col-add opt-col-add--cancel" (click)="cancelQuickAdd()" *ngIf="quickAddColumn === 'done'" matTooltip="Cancel">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Quick-add -->
        <div class="opt-quick-add" *ngIf="quickAddColumn === 'done'">
          <input class="opt-qa-input" [(ngModel)]="quickAddTitle" placeholder="Task name…" autofocus
            (keydown.enter)="saveQuickAdd()" (keydown.escape)="cancelQuickAdd()">
          <button class="opt-qa-save" (click)="saveQuickAdd()" [disabled]="!quickAddTitle.trim() || quickAddSaving">
            <mat-icon>keyboard_return</mat-icon> Save
          </button>
          <div class="opt-qa-hints">
            <span><mat-icon>person_outline</mat-icon> Assignee</span>
            <span><mat-icon>calendar_today</mat-icon> Date</span>
            <span><mat-icon>flag_outlined</mat-icon> Priority</span>
          </div>
        </div>

        <div class="opt-col-cards" cdkDropList [id]="'done'" [cdkDropListData]="taskdone" (cdkDropListDropped)="onTaskDrop($event)">
          <article class="opt-card" *ngFor="let task of taskdone; trackBy: trackByTask"
            cdkDrag [cdkDragData]="task"
            [style.border-left-color]="getPriorityColor(task.priority)"
            (click)="goToTaskDetail(task.id)">
            <div class="opt-card-body">
              <h3 class="opt-card-title opt-card-title--done">{{ task.title }}</h3>
              <div class="opt-card-assignees">
                <ng-container *ngIf="getAssigneesList(task).length; else noAssigneesDone">
                  <span class="opt-assignee-chip" *ngFor="let a of getAssigneesList(task)" [matTooltip]="a.name">
                    <span class="opt-assignee-initial">{{ (a.name || '?')[0] | uppercase }}</span>
                    <span class="opt-assignee-name">{{ a.name }}</span>
                  </span>
                </ng-container>
                <ng-template #noAssigneesDone>
                  <span class="opt-assignees-empty"><mat-icon>person_outline</mat-icon> Unassigned</span>
                </ng-template>
              </div>
              <div class="opt-card-meta">
                <span class="opt-meta" *ngIf="task.dueDate">
                  <mat-icon>event</mat-icon>{{ task.dueDate | date:'MMM d' }}
                </span>
              </div>
              <div class="opt-card-creator">
                <mat-icon>account_circle</mat-icon>{{ getTaskCreatedBy(task) }}
              </div>
            </div>
            <div class="opt-card-footer" (click)="$event.stopPropagation()">
              <div class="opt-card-actions">
                <button class="opt-ca-btn" (click)="goToTaskDetail(task.id)" matTooltip="Open"><mat-icon>open_in_new</mat-icon></button>
                <button class="opt-ca-btn" (click)="updateTaskStatus(task.id, 'todo')" matTooltip="Reopen"><mat-icon>undo</mat-icon></button>
                <button class="opt-ca-btn opt-ca-btn--danger" (click)="deleteTask(task.id)" matTooltip="Delete"><mat-icon>delete</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- ── On Hold ── -->
      <section class="opt-column">
        <div class="opt-col-head">
          <span class="opt-col-dot opt-col-dot--hold"></span>
          <h2 class="opt-col-title">On Hold</h2>
          <span class="opt-col-count">{{ taskonhold.length }}</span>
          <button class="opt-col-add" (click)="openQuickAdd('hold')" *ngIf="quickAddColumn !== 'hold'" matTooltip="Add task">
            <mat-icon>add</mat-icon>
          </button>
          <button class="opt-col-add opt-col-add--cancel" (click)="cancelQuickAdd()" *ngIf="quickAddColumn === 'hold'" matTooltip="Cancel">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Quick-add -->
        <div class="opt-quick-add" *ngIf="quickAddColumn === 'hold'">
          <input class="opt-qa-input" [(ngModel)]="quickAddTitle" placeholder="Task name…" autofocus
            (keydown.enter)="saveQuickAdd()" (keydown.escape)="cancelQuickAdd()">
          <button class="opt-qa-save" (click)="saveQuickAdd()" [disabled]="!quickAddTitle.trim() || quickAddSaving">
            <mat-icon>keyboard_return</mat-icon> Save
          </button>
          <div class="opt-qa-hints">
            <span><mat-icon>person_outline</mat-icon> Assignee</span>
            <span><mat-icon>calendar_today</mat-icon> Date</span>
            <span><mat-icon>flag_outlined</mat-icon> Priority</span>
          </div>
        </div>

        <div class="opt-col-cards" cdkDropList [id]="'hold'" [cdkDropListData]="taskonhold" (cdkDropListDropped)="onTaskDrop($event)">
          <article class="opt-card" *ngFor="let task of taskonhold; trackBy: trackByTask"
            cdkDrag [cdkDragData]="task"
            [style.border-left-color]="getPriorityColor(task.priority)"
            (click)="goToTaskDetail(task.id)">
            <div class="opt-card-body">
              <h3 class="opt-card-title">{{ getTaskTitle(task) }}</h3>
              <p class="opt-card-desc" *ngIf="task.description">{{ task.description }}</p>
              <div class="opt-card-assignees">
                <ng-container *ngIf="getAssigneesList(task).length; else noAssigneesHold">
                  <span class="opt-assignee-chip" *ngFor="let a of getAssigneesList(task)" [matTooltip]="a.name">
                    <span class="opt-assignee-initial">{{ (a.name || '?')[0] | uppercase }}</span>
                    <span class="opt-assignee-name">{{ a.name }}</span>
                  </span>
                </ng-container>
                <ng-template #noAssigneesHold>
                  <span class="opt-assignees-empty"><mat-icon>person_outline</mat-icon> Unassigned</span>
                </ng-template>
              </div>
              <div class="opt-card-meta">
                <span class="opt-meta" *ngIf="task.dueDate">
                  <mat-icon>event</mat-icon>{{ task.dueDate | date:'MMM d' }}
                </span>
              </div>
              <div class="opt-card-creator">
                <mat-icon>account_circle</mat-icon>{{ getTaskCreatedBy(task) }}
              </div>
            </div>
            <div class="opt-card-footer" (click)="$event.stopPropagation()">
              <div class="opt-card-actions">
                <button class="opt-ca-btn" (click)="goToTaskDetail(task.id)" matTooltip="Open"><mat-icon>open_in_new</mat-icon></button>
                <button class="opt-ca-btn" (click)="updateTaskStatus(task.id, 'todo')" matTooltip="Back to Todo"><mat-icon>undo</mat-icon></button>
                <button class="opt-ca-btn" (click)="updateTaskStatus(task.id, 'in-progress')" matTooltip="Resume"><mat-icon>play_circle</mat-icon></button>
                <button class="opt-ca-btn opt-ca-btn--danger" (click)="deleteTask(task.id)" matTooltip="Delete"><mat-icon>delete</mat-icon></button>
              </div>
            </div>
          </article>
        </div>
      </section>

    </div>
  </div>

  <!-- ══════════════════ LIST VIEW ══════════════════ -->
  <div class="opt-list-view" *ngIf="viewMode === 'list' && (!isLoading || taskdata.length)">
    <div class="opt-list-header">
      <span class="opt-list-col opt-list-col--status">Status</span>
      <span class="opt-list-col opt-list-col--title">Task</span>
      <span class="opt-list-col opt-list-col--assignee">Assignee</span>
      <span class="opt-list-col opt-list-col--priority">Priority</span>
      <span class="opt-list-col opt-list-col--date">Due</span>
      <span class="opt-list-col opt-list-col--actions"></span>
    </div>
    <div class="opt-list-row" *ngFor="let task of taskdata; trackBy: trackByTask"
      [style.border-left-color]="getPriorityColor(task.priority)"
      (click)="goToTaskDetail(task.id)">
      <span class="opt-list-col opt-list-col--status">
        <span class="opt-status-pill opt-status-pill--{{ task.status || 'todo' }}">{{ getStatusLabel(task.status || 'todo') }}</span>
      </span>
      <span class="opt-list-col opt-list-col--title">{{ task.title }}</span>
      <span class="opt-list-col opt-list-col--assignee">{{ getAssigneesDisplay(task) || '—' }}</span>
      <span class="opt-list-col opt-list-col--priority">
        <span class="opt-priority-pill opt-priority-pill--{{ task.priority || 'medium' }}">{{ getPriorityLabel(task.priority || 'medium') }}</span>
      </span>
      <span class="opt-list-col opt-list-col--date">
        <span *ngIf="task.dueDate">{{ task.dueDate | date:'MMM d' }}</span>
        <span class="opt-muted" *ngIf="!task.dueDate">—</span>
      </span>
      <div class="opt-list-col opt-list-col--actions" (click)="$event.stopPropagation()">
        <button class="opt-ca-btn" (click)="goToTaskDetail(task.id)" matTooltip="Open"><mat-icon>open_in_new</mat-icon></button>
        <button class="opt-ca-btn opt-ca-btn--danger" (click)="deleteTask(task.id)" matTooltip="Delete"><mat-icon>delete</mat-icon></button>
      </div>
    </div>
    <div class="opt-list-empty" *ngIf="!taskdata.length">No tasks yet</div>
  </div>

  <!-- ── Empty state ── -->
  <div class="opt-empty" *ngIf="!isLoading && !taskdata.length">
    <mat-icon>assignment</mat-icon>
    <p>No tasks yet</p>
    <span>Click <strong>+</strong> in any column header to add one.</span>
  </div>

</div>
